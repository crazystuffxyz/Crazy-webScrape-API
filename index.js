import e from"express";import t from"axios";import{JSDOM as r}from"jsdom";import{Readability as a}from"@mozilla/readability";import*as s from"cheerio";import n from"turndown";import o from"path";import{fileURLToPath as i}from"url";const c=i(import.meta.url),l=o.dirname(c),u=e(),m=process.env.PORT||3e3;u.use(e.json()),u.use(e.static(o.join(l,"public")));const d=new n({headingStyle:"atx",hr:"---",bulletListMarker:"*",codeBlockStyle:"fenced",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",preformattedCode:!0});d.addRule("strikethrough",{filter:["del","s","strike"],replacement:e=>`~${e}~`}),d.keep(["table","thead","tbody","tr","th","td"]);const p={accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"en-US,en;q=0.9",dnt:"1",priority:"u=0, i","sec-ch-ua":'"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"none","sec-fetch-user":"?1","upgrade-insecure-requests":"1","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36"},h={accept:"*/*","accept-language":"en-US,en;q=0.9",priority:"u=1, i","sec-ch-ua":'"Chromium";v="122", "Not(A:Brand";v="24", "Google Chrome";v="122"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"};async function g(e,r,a,s=1){const n=encodeURIComponent(e),o=`https://leta.mullvad.net/search/__data.json?${new URLSearchParams({q:e,engine:r,page:a.toString(),"x-sveltekit-invalidated":"001"}).toString()}`,i={...h,Referer:`https://leta.mullvad.net/search?q=${n}&engine=${r}&page=${a}`};for(let r=1;r<=s+1;r++)try{const e=await t.get(o,{headers:i,timeout:15e3});if(200!==e.status)throw new Error(`Non-200 status: ${e.status}`);const r=e.data;if(!r||!Array.isArray(r.nodes)||0===r.nodes.length)return{results:[],hasMore:!1,actualResultsOnPage:0};const a=r.nodes.find(e=>e&&"data"===e.type&&Array.isArray(e.data));if(!a||a.data.length<4)return{results:[],hasMore:!1,actualResultsOnPage:0};const s=a.data,n=!0===s[1];let c=s.find(e=>Array.isArray(e)&&e.every(e=>"number"==typeof e));if(!Array.isArray(c))return{results:[],hasMore:n,actualResultsOnPage:0};const l=c.map(e=>{if("number"!=typeof e||!s[e])return null;const t=s[e];if("object"!=typeof t||null===t)return null;const r=s[t.title],a=s[t.link],n=s[t.snippet];return r&&a&&"string"==typeof a?{title:String(r||""),url:a,description:String(n||"")}:null}).filter(e=>null!==e);return{results:l,hasMore:n,actualResultsOnPage:l.length}}catch(t){if(r>s)return console.error(`[Mullvad Client] Max retries reached for query "${e}". Error: ${t.message}`),{results:[],hasMore:!1,actualResultsOnPage:0};await new Promise(e=>setTimeout(e,1500*r))}return{results:[],hasMore:!1,actualResultsOnPage:0}}async function f(e){const n=(await t.get(e,{headers:p,timeout:15e3})).data,o=s.load(n);o('script, style, link, iframe, aside, form, noscript, [aria-hidden="true"], .ads, .advertisement, embed, video, canvas').remove(),o("img").each((e,t)=>{const r=o(t).attr("alt")?.trim()||"No description";o(t).replaceWith(`<p>[Image: ${r}]</p>`)});const i=new r(o.html(),{url:e}),c=new a(i.window.document).parse();if(c&&c.content)return c.content;throw new Error(`Readability could not find main content on ${e}.`)}function y(e){const{author:t,title:r,year:a,site:s,url:n,accessed:o}=e,i="Unknown Author"===t?"":t;return{APA:`${i} (${a}). *${r}*. ${s}. ${n}`,MLA:`${i}. "${r}." *${s}*, ${a}, ${n}. Accessed ${o}.`,Chicago:`${i}. "${r}." *${s}*, ${a}. Accessed ${o}. ${n}.`}}async function w(e){const n=(await t.get(e,{headers:p,timeout:15e3})).data,o=new r(n,{url:e}),i=new a(o.window.document).parse(),c=s.load(n),l=i?.byline||c('meta[name="author"]').attr("content")||"Unknown Author",u=i?.title||c("title").first().text().trim()||"Untitled",m=c('meta[property="article:published_time"]').attr("content")||c('meta[name="date"]').attr("content"),d=m?new Date(m).getFullYear():"n.d.",h=i?.siteName||c('meta[property="og:site_name"]').attr("content")||new URL(e).hostname,g=function(e){if(!e)return"n.d.";const t=new Date(e);return isNaN(t)?"n.d.":t.toISOString().split("T")[0]}(new Date),f={author:l.replace(/\s+/g," ").trim(),title:u.replace(/\s+/g," ").trim(),year:isNaN(parseInt(d))?"n.d.":parseInt(d),site:h.replace(/\s+/g," ").trim(),url:e,accessed:g,excerpt:i?.excerpt||c('meta[name="description"]').attr("content")||"",content_text:i?.textContent||"",content_html:i?.content||""};return{citations:y(f),metadata:f}}u.get("/search",async(e,t)=>{const{q:r,limit:a}=e.query;if(!r)return t.status(400).json({error:'Query parameter "q" is required.'});const s=parseInt(a,10)||10;try{const e=await async function(e,t=20,r=5,a=1,s="google"){if(!e||""===String(e).trim())return[];let n=[];const o=new Set;let i=1,c=!0,l=0;for(;l<r&&c&&n.length<t;){const r=await g(e,s,i,a);if(l++,r.results.length>0)for(const e of r.results)if(e.url&&!o.has(e.url)&&(n.push(e),o.add(e.url),n.length>=t)){c=!1;break}r.hasMore&&0!==r.actualResultsOnPage||(c=!1),c&&i++}return n.slice(0,t)}(r,s,5,1,"google");if(0===e.length)return t.status(404).json({message:"No results found for your query.",results:[]});t.json({query:r,resultCount:e.length,results:e.map(({title:e,url:t,description:r})=>({title:e,url:t,description:r}))})}catch(e){console.error(`[API /search] Error: ${e.message}`),t.status(500).json({error:"Failed to fetch search results."})}}),u.get("/article",async(e,t)=>{const{url:r}=e.query;if(!r)return t.status(400).json({error:'Query parameter "url" is required.'});try{new URL(r);const e=await w(r);t.json(e)}catch(e){console.error(`[API /article] Error processing ${r}: ${e.message}`),t.status(500).json({error:`Failed to process the article from ${r}.`,details:e.message})}}),u.get("/markdown",async(e,t)=>{const{url:r}=e.query;if(!r)return t.status(400).json({error:'Query parameter "url" is required.'});try{new URL(r);const e=await f(r),a=d.turndown(e);t.setHeader("Content-Type","text/markdown; charset=utf-8"),t.send(a)}catch(e){console.error(`[API /markdown] Error processing ${r}: ${e.message}`),t.status(500).json({error:`Failed to get Markdown from ${r}.`,details:e.message})}}),u.get("/html",async(e,t)=>{const{url:r}=e.query;if(!r)return t.status(400).json({error:'Query parameter "url" is required.'});try{new URL(r);const e=await f(r);t.setHeader("Content-Type","text/html; charset=utf-8"),t.send(e)}catch(e){console.error(`[API /html] Error processing ${r}: ${e.message}`),t.status(500).json({error:`Failed to get HTML from ${r}.`,details:e.message})}}),u.get("/citation",async(e,t)=>{const{url:r}=e.query;if(!r)return t.status(400).json({error:'Query parameter "url" is required.'});try{new URL(r);const e=await w(r);t.json({citations:e.citations,metadata:e.metadata})}catch(e){console.error(`[API /citation] Error processing ${r}: ${e.message}`),t.status(500).json({error:`Failed to generate citation from ${r}.`,details:e.message})}}),u.listen(m,()=>{console.log(`ðŸš€ Scraper API is live and listening on http://localhost:${m}`)});